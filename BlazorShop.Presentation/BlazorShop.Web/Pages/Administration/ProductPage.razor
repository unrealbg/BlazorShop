@page "/product"
@layout AdminLayout

<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
    <div class="bg-white/80 rounded-xl shadow p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">Manage Products</h2>
            <button class="inline-flex items-center gap-2 rounded bg-neutral-900 text-white px-4 py-2 font-semibold hover:bg-neutral-800" @onclick="AddProduct">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 4v16M4 12h16"/></svg>
                Add Product
            </button>
        </div>

        <div class="mt-4 overflow-auto" style="max-height:500px">
            @if (_products.Any())
            {
                <table class="min-w-full text-sm">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-neutral-100/90 text-left">
                            <th class="px-3 py-2">Id</th>
                            <th class="px-3 py-2">Image</th>
                            <th class="px-3 py-2">Name</th>
                            <th class="px-3 py-2">Description</th>
                            <th class="px-3 py-2">Price</th>
                            <th class="px-3 py-2">Quantity</th>
                            <th class="px-3 py-2">Created Date</th>
                            <th class="px-3 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-neutral-200">
                        @foreach (var product in _products)
                        {
                            <tr>
                                <td class="px-3 py-2 align-top">@product.Id</td>
                                <td class="px-3 py-2 align-top"><img src="@product.Image" alt="@product.Name" class="h-12 w-12 object-cover rounded" /></td>
                                <td class="px-3 py-2 align-top">@product.Name</td>
                                <td class="px-3 py-2 align-top">@product.Description</td>
                                <td class="px-3 py-2 align-top">@product.Price</td>
                                <td class="px-3 py-2 align-top">@product.Quantity</td>
                                <td class="px-3 py-2 align-top">@product.CreatedOn</td>
                                <td class="px-3 py-2 align-top">
                                    <div class="flex items-center justify-center gap-3">
                                        <button class="text-blue-600 hover:text-blue-700" title="Edit" @onclick="() => StartEdit(product)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                                        </button>
                                        <button class="text-red-600 hover:text-red-700" title="Delete" @onclick="() => ConfirmDelete(product.Id)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 7h12M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2m-1 0l-1 12a2 2 0 01-2 2h-2a2 2 0 01-2-2L8 7"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="mt-6 rounded-md bg-blue-50 text-blue-800 px-6 py-5 text-center shadow font-semibold">
                    No products found.
                </div>
            }
        </div>
    </div>
</section>

<!-- Add Product Dialog -->
<ModalDialog @bind-IsVisible="_showDialog">
    <Header>
        <h5 class="text-lg font-semibold">Add New Product</h5>
    </Header>
    <Body>
        <EditForm Model="_product" OnValidSubmit="SaveProduct">
            <DataAnnotationsValidator />
            <div class="form-group">
                <FloatingTextInput @bind-Value="_product.Name" Label="Product Name" class="w-full" />
                <ValidationMessage For="@(() => _product.Name)" />
            </div>
            <div class="form-group">
                <InputNumber @bind-Value="_product.Price" class="w-full border rounded px-3 py-2" />
                <label class="block text-sm text-neutral-600 mt-1">Price</label>
                <ValidationMessage For="@(() => _product.Price)" />
            </div>
            <div class="form-group">
                <FloatingNumberInput @bind-Value="_product.Quantity" Label="Quantity" class="w-full" />
                <ValidationMessage For="@(() => _product.Quantity)" />
            </div>
            <div class="form-group">
                <FloatingTextAreaInput @bind-Value="_product.Description" Label="Product Description" class="w-full" />
                <ValidationMessage For="@(() => _product.Description)" />
            </div>
            <div class="form-group">
                <InputSelect id="category" class="w-full border rounded px-3 py-2" @bind-Value="_product.CategoryId">
                    <option value="" selected>-- Select a Category --</option>
                    @foreach (var category in _categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </InputSelect>
                <label for="category" class="block text-sm text-neutral-600 mt-1">Category</label>
                <ValidationMessage For="@(() => _product.CategoryId)" />
            </div>
            <div class="form-group flex items-center justify-between">
                <label class="inline-flex items-center gap-2 rounded bg-neutral-900 text-white px-4 py-2 font-semibold hover:bg-neutral-800 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7H5"/></svg>
                    <span>Upload Image</span>
                    <InputFile OnChange="EventCallback.Factory.Create<InputFileChangeEventArgs>(this, OnFileSelected)" accept="image/*" class="sr-only" />
                </label>
                @if (!string.IsNullOrEmpty(_previewImageUrl))
                {
                    <img src="@_previewImageUrl" alt="Preview Image" class="ml-4 max-w-24 max-h-24 border rounded" />
                }
                <ValidationMessage For="@(() => _product.Image)" />
            </div>

            <hr />
            <div class="flex justify-end gap-2">
                <button class="inline-flex items-center rounded bg-neutral-900 text-white px-4 py-2 font-semibold hover:bg-neutral-800" type="submit">Save</button>
                <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" type="button" @onclick="Cancel">Cancel</button>
            </div>
        </EditForm>
    </Body>
</ModalDialog>

<!-- Edit Product Dialog -->
<ModalDialog @bind-IsVisible="_showEditDialog">
    <Header>
        <h5 class="text-lg font-semibold">Edit Product</h5>
    </Header>
    <Body>
        <EditForm Model="_editProduct" OnValidSubmit="UpdateProductAsync">
            <DataAnnotationsValidator />
            <div class="form-group">
                <FloatingTextInput @bind-Value="_editProduct.Name" Label="Product Name" class="w-full" />
                <ValidationMessage For="@(() => _editProduct.Name)" />
            </div>
            <div class="form-group">
                <InputNumber @bind-Value="_editProduct.Price" class="w-full border rounded px-3 py-2" />
                <label class="block text-sm text-neutral-600 mt-1">Price</label>
                <ValidationMessage For="@(() => _editProduct.Price)" />
            </div>
            <div class="form-group">
                <FloatingNumberInput @bind-Value="_editProduct.Quantity" Label="Quantity" class="w-full" />
                <ValidationMessage For="@(() => _editProduct.Quantity)" />
            </div>
            <div class="form-group">
                <FloatingTextAreaInput @bind-Value="_editProduct.Description" Label="Product Description" class="w-full" />
                <ValidationMessage For="@(() => _editProduct.Description)" />
            </div>
            <div class="form-group">
                <InputSelect id="edit-category" class="w-full border rounded px-3 py-2" @bind-Value="_editProduct.CategoryId">
                    <option value="" selected>-- Select a Category --</option>
                    @foreach (var category in _categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </InputSelect>
                <label for="edit-category" class="block text-sm text-neutral-600 mt-1">Category</label>
                <ValidationMessage For="@(() => _editProduct.CategoryId)" />
            </div>
            <div class="form-group flex items-center justify-between">
                <label class="inline-flex items-center gap-2 rounded bg-neutral-900 text-white px-4 py-2 font-semibold hover:bg-neutral-800 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 5v14m7-7H5"/></svg>
                    <span>Upload Image</span>
                    <InputFile OnChange="EventCallback.Factory.Create<InputFileChangeEventArgs>(this, OnEditFileSelected)" accept="image/*" class="sr-only" />
                </label>
                @if (!string.IsNullOrEmpty(_previewImageUrl))
                {
                    <img src="@_previewImageUrl" alt="Preview Image" class="ml-4 max-w-24 max-h-24 border rounded" />
                }
                <ValidationMessage For="@(() => _editProduct.Image)" />
            </div>

            <hr />
            <div class="flex justify-end gap-2">
                <button class="inline-flex items-center rounded bg-neutral-900 text-white px-4 py-2 font-semibold hover:bg-neutral-800" type="submit">Update</button>
                <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" type="button" @onclick="CancelEdit">Cancel</button>
            </div>
        </EditForm>
    </Body>
</ModalDialog>

<ModalDialog @bind-IsVisible="_showConfirmDeleteDialog">
    <Header>
        <h5 class="text-lg font-semibold">Confirm Delete</h5>
    </Header>
    <Body>
        Are you sure you want to delete the product
        <span class="text-red-600"><strong>@_producToDeleteName</strong></span>?
    </Body>
    <Footer>
        <button class="inline-flex items-center rounded bg-red-600 text-white px-4 py-2 font-semibold hover:bg-red-700" @onclick="DeleteProductConfirmed">Yes, Delete</button>
        <button class="inline-flex items-center rounded bg-neutral-200 text-neutral-900 px-4 py-2 font-semibold hover:bg-neutral-300" @onclick="CancelDelete">Cancel</button>
    </Footer>
</ModalDialog>